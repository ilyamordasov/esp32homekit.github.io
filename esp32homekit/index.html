<html>
	<head>
		<meta name="mobile-web-app-capable" content="yes">
    	<meta name="apple-mobile-web-app-capable" content="yes">
	</head>
	<body>
		<input id="nameInput" placeholder="Device Name" type="text"></input>
		<button id="connectBtn">Connect</button>
		<script type="text/javascript">
			"use strict";

			function handleError(error)
			{
				console.log(error);
				if (error.toString().match(/User cancelled/))
				return;  // User didn't make a choice, no error needed.
				else
				alert(error);
			}

			function anyDeviceFilter()
			{
				// This is the closest we can get for now to get all devices.
				// https://github.com/WebBluetoothCG/web-bluetooth/issues/234
				return Array.from('0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ')
				  .map(c => ({namePrefix: c}))
				  .concat({name: ''});
			}

			connectBtn.addEventListener('pointerup', function(event)
			{
				Promise.resolve()
				.then(_ => {
					if (!navigator.bluetooth)
					  throw "No Web Bluetooth support.";
					return navigator.bluetooth.requestDevice({
					  filters: anyDeviceFilter(),
					  optionalServices: ['generic_access']
					})
				}) 
				.then(device => {
					nameInput.value = "";
					return device.gatt.connect().catch(error => {
					  throw "Unable to connect. Some devices refuse connections.";
					});
				})
				.then(server => server.getPrimaryService("generic_access"))
				.then(service => service.getCharacteristic("gap.device_name"))
				.then(characteristic => {
					window.deviceName = characteristic;
					return characteristic.readValue();
				})
				.then(value => {
					window.value = value;
					alert(value);
					nameInput.value = new TextDecoder("utf-8").decode(value);
				})
				.catch(handleError)
			});
		</script>
	</body>
</html>